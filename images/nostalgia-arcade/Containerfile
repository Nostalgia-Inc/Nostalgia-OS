FROM ghcr.io/ublue-os/bazzite-deck@sha256:98a0c1fbd89c150ed6ba9d356b3a3ddc11361c4d3a26c8fd17321b9c762d1081

LABEL org.opencontainers.image.title="Nostalgia Arcade"
LABEL org.opencontainers.image.description="Bazzite Kinoite base, Nostalgia branding, KDE defaults, arcade-themed customizations"
LABEL org.opencontainers.image.authors="Nostalgia Inc."
LABEL org.opencontainers.image.source="https://github.com/Nostalgia-Inc/Nostalgia-OS"

# ── Execute additional package installation and system setup ──────────────────
COPY build_files/build.sh /tmp/build.sh
RUN chmod +x /tmp/build.sh && /tmp/build.sh && rm /tmp/build.sh && ostree container commit

# ── Copy shared branding (wallpapers, logos, etc.) ────────────────────────────
# path exists in repo: common/...\nCOPY common/ /usr/share/nostalgia/

# ── Plymouth theme (build-time) ───────────────────────────────────────────────
# path exists in repo: images/nostalgia-arcade/plymouth/nostalgia-arcade/*
COPY images/nostalgia-arcade/plymouth/nostalgia-arcade /usr/share/plymouth/themes/nostalgia-arcade
RUN set -eux; \
    install -d /etc/plymouth; \
    printf '%s\n[Daemon]\nTheme=nostalgia-arcade\nShowDelay=0\n' > /etc/plymouth/plymouthd.conf; \
    ostree container commit

# ── KDE default wallpaper for new users via /etc/skel ─────────────────────────
# if you ship: common/branding/wallpaper.png
RUN if [ -f /usr/share/nostalgia/branding/wallpaper.png ]; then \
      install -D /usr/share/nostalgia/branding/wallpaper.png /usr/share/nostalgia/Nostalgia.png && \
      install -d /etc/skel/.config && \
      printf '%s\n[Containments][1][Wallpaper][org.kde.image][General]\nImage=file:///usr/share/nostalgia/Nostalgia.png\n' \
        > /etc/skel/.config/plasma-org.kde.plasma.desktop-appletsrc ; \
    fi

# ── Ensure wallpaper is applied on first login ────────────────────────────────
COPY images/nostalgia-crt/scripts/nostalgia-apply-wallpaper.sh /usr/libexec/nostalgia-apply-wallpaper
COPY images/nostalgia-crt/systemd/nostalgia-apply-wallpaper.service /usr/lib/systemd/user/nostalgia-apply-wallpaper.service
RUN set -eux; \
    chmod 0755 /usr/libexec/nostalgia-apply-wallpaper; \
    systemctl --global enable nostalgia-apply-wallpaper.service; \
    ostree container commit

# ── First boot setup script and service ────────────────────────────────────────
COPY images/nostalgia-arcade/scripts/10-nostalgia-arcade-setup.sh /usr/libexec/nostalgia-setup
COPY images/nostalgia-arcade/systemd/nostalgia-setup.service /usr/lib/systemd/user/nostalgia-setup.service
RUN set -eux; \
    chmod 0755 /usr/libexec/nostalgia-setup; \
    systemctl --global enable nostalgia-setup.service; \
    ostree container commit

# ── Power and performance tuning script and service ────────────────────────────
COPY images/nostalgia-arcade/scripts/nostalgia-arcade-tuning.sh /usr/libexec/nostalgia-power-tuning
COPY images/nostalgia-arcade/systemd/nostalgia-power-tuning.service /usr/lib/systemd/system/nostalgia-power-tuning.service
RUN set -eux; \
    chmod 0755 /usr/libexec/nostalgia-power-tuning; \
    systemctl enable nostalgia-power-tuning.service; \
    ostree container commit

# ── GRUB theme configuration ───────────────────────────────────────────────────
COPY images/nostalgia-arcade/grub/theme.txt /usr/share/grub/themes/nostalgia-arcade/theme.txt
RUN set -eux; \
    mkdir -p /usr/share/grub/themes/nostalgia-arcade; \
    install -D /usr/share/grub/themes/nostalgia-arcade/theme.txt /boot/grub2/themes/nostalgia-arcade/theme.txt; \
    ostree container commit

# ── Additional tools for arcade experience ─────────────────────────────────────
RUN rpm-ostree install mpv && ostree container commit
