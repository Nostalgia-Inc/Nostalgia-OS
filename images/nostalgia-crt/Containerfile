FROM ghcr.io/ublue-os/bazzite-deck:latest

LABEL org.opencontainers.image.title="Nostalgia OS"
LABEL org.opencontainers.image.description="Bazzite Deck base, Nostalgia branding, KDE defaults, and first-boot extras"
LABEL org.opencontainers.image.authors="Nostalgia Inc."
LABEL org.opencontainers.image.source="https://github.com/Nostalgia-Inc/Nostalgia-OS"

# ── Copy shared branding assets ────────────────────────────────────────────────
# Expect your repo has: common/branding/wallpaper.png etc.
COPY common/ /usr/share/nostalgia/

# ── Plymouth theme + config (build-time) ───────────────────────────────────────
# You already have a Plymouth theme folder at images/nostalgia-crt/plymouth/nostalgia
COPY images/nostalgia-crt/plymouth/nostalgia /usr/share/plymouth/themes/nostalgia
RUN install -d /etc/plymouth && \
    printf '%s\n[Daemon]\nTheme=nostalgia\nShowDelay=0\n' > /etc/plymouth/plymouthd.conf

# ── (Optional) SDDM: only select your theme if you ship one ───────────────────
# If you provide a full SDDM theme under images/nostalgia-crt/sddm/nostalgia, uncomment:
# COPY images/nostalgia-crt/sddm/nostalgia /usr/share/sddm/themes/nostalgia
# RUN install -d /etc/sddm.conf.d && \
#     printf '%s\n[Theme]\nCurrent=nostalgia\n' > /etc/sddm.conf.d/10-nostalgia-theme.conf

# ── KDE default wallpaper for NEW users via /etc/skel ─────────────────────────
# If you ship /usr/share/nostalgia/branding/wallpaper.png, set the default
RUN if [ -f /usr/share/nostalgia/branding/wallpaper.png ]; then \
      install -D /usr/share/nostalgia/branding/wallpaper.png /usr/share/nostalgia/Nostalgia.png && \
      install -d /etc/skel/.config && \
      printf '%s\n[Containments][1][Wallpaper][org.kde.image][General]\nImage=file:///usr/share/nostalgia/Nostalgia.png\n' \
        > /etc/skel/.config/plasma-org.kde.plasma.desktop-appletsrc ; \
    fi

# ── Ship Game Mode intro/outro files in the image ─────────────────────────────
# Put your .webm clips in repo at images/nostalgia-crt/gamescope/media/
# (Use .gitkeep if empty to avoid COPY errors)
RUN install -d /usr/share/nostalgia/media
COPY images/nostalgia-crt/gamescope/media/ /usr/share/nostalgia/media/

# Also seed NEW users with Steam uioverrides pointing to those clips
RUN install -d /etc/skel/.steam/root/config/uioverrides/movies && \
    if [ -f /usr/share/nostalgia/media/boot-intro.webm ]; then \
      ln -sf /usr/share/nostalgia/media/boot-intro.webm \
             /etc/skel/.steam/root/config/uioverrides/movies/deck_startup.webm ; \
    fi && \
    if [ -f /usr/share/nostalgia/media/boot-outro.webm ]; then \
      ln -sf /usr/share/nostalgia/media/boot-outro.webm \
             /etc/skel/.steam/root/config/uioverrides/movies/deck_shutdown.webm ; \
    fi

# ── First-boot: only runtime/network tasks ────────────────────────────────────
COPY images/nostalgia-crt/firstboot/10-nostalgia-setup.sh /usr/lib/nostalgia/10-nostalgia-setup.sh
COPY images/nostalgia-crt/firstboot/nostalgia-firstboot.service /usr/lib/systemd/system/nostalgia-firstboot.service
RUN chmod +x /usr/lib/nostalgia/10-nostalgia-setup.sh && \
    ln -sv /usr/lib/systemd/system/nostalgia-firstboot.service \
           /etc/systemd/system/graphical.target.wants/nostalgia-firstboot.service || true
    # enable via static symlink (persist on OSTree)
    ln -sv /usr/lib/systemd/system/nostalgia-firstboot.service \
           /etc/systemd/system/graphical.target.wants/nostalgia-firstboot.service || true

# ── Handy tools used by our flow ──────────────────────────────────────────────
RUN rpm-ostree install mpv && ostree container commit
